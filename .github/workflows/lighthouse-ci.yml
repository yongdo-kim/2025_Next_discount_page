name: '[Lighthouse] CI'

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (UTC 0ì‹œ), ì˜¤í›„ 6ì‹œ (UTC 9ì‹œ)ì— ì‹¤í–‰
    - cron: '0 0,9 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        browser: [chrome, safari]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Safari browser (WebKit)
        if: matrix.browser == 'safari'
        run: |
          npx playwright install webkit
      
      - name: Cache Lighthouse CI database
        uses: actions/cache@v3
        with:
          path: lhci.db
          key: lighthouse-db-${{ runner.os }}-${{ matrix.browser }}-${{ github.ref_name }}
          restore-keys: |
            lighthouse-db-${{ runner.os }}-${{ matrix.browser }}-

      - name: Cache previous Lighthouse results
        uses: actions/cache@v3
        with:
          path: .lighthouse-previous
          key: lighthouse-results-${{ runner.os }}-${{ matrix.browser }}-${{ github.ref_name }}-latest
          restore-keys: |
            lighthouse-results-${{ runner.os }}-${{ matrix.browser }}-${{ github.ref_name }}-latest
            lighthouse-results-${{ runner.os }}-${{ matrix.browser }}-${{ github.ref_name }}-

      - name: Cache Lighthouse history
        uses: actions/cache@v3
        with:
          path: .lighthouse-history
          key: lighthouse-history-${{ runner.os }}-${{ matrix.browser }}-${{ github.ref_name }}
          restore-keys: |
            lighthouse-history-${{ runner.os }}-${{ matrix.browser }}-

      - name: Debug cache status and fallback to artifacts
        run: |
          echo "ðŸ” Checking cache restore status for ${{ matrix.browser }}..."
          echo "Cache key: lighthouse-results-${{ runner.os }}-${{ matrix.browser }}-${{ github.ref_name }}-latest"
          echo "Previous results directory:"
          if [ -d ".lighthouse-previous" ]; then
            echo "âœ… .lighthouse-previous directory exists (from cache)"
            ls -la .lighthouse-previous/ || echo "Directory is empty"
          else
            echo "âŒ .lighthouse-previous directory not found from cache"
            echo "ðŸ”„ Attempting to restore from artifacts as fallback..."
            
            # Artifacts ë°±ì—…ì—ì„œ ë³µì› ì‹œë„ (ì‹¤ì œë¡œëŠ” ìˆ˜ë™ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œí•´ì•¼ í•¨)
            # ì—¬ê¸°ì„œëŠ” ì²« ì‹¤í–‰ìž„ì„ ì•Œë¦¬ëŠ” ë©”ì‹œì§€ë§Œ í‘œì‹œ
            echo "â„¹ï¸  This appears to be the first run or cache was cleared"
            echo "   Next run will have previous results to compare with"
          fi
          
      - name: Install dependencies
        run: npm ci

      - name: Create Puppeteer script for WebKit
        if: matrix.browser == 'safari'
        run: |
          cat > puppeteer-script.js << 'EOF'
          const puppeteer = require('puppeteer');
          
          module.exports = async () => {
            const browser = await puppeteer.launch({
              product: 'webkit',
              headless: true,
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            return browser;
          };
          EOF
        
      - name: Build project
        run: npm run build
        
      - name: Start server
        run: npm run prod &
        env:
          NODE_ENV: production

      - name: Wait for server to be ready
        run: npx wait-on http://localhost:3000 --timeout 60000

      - name: Run Lighthouse collect
        run: |
          echo "ðŸš€ Running Lighthouse collect for ${{ matrix.browser }}..."
          
          if [ "${{ matrix.browser }}" = "safari" ]; then
            echo "ðŸ“± Using Safari/WebKit with custom puppeteer script"
            npx lhci collect --settings.throttling.cpuSlowdownMultiplier=4 --puppeteer-script puppeteer-script.js
          else
            echo "ðŸŒ Using Chrome with default settings"  
            npx lhci collect --settings.throttling.cpuSlowdownMultiplier=4
          fi
          
          echo "ðŸ“Š Lighthouse collect completed. Checking results..."
          if [ -d ".lighthouseci" ]; then
            echo "âœ… Results directory created successfully"
            ls -la .lighthouseci/
          else
            echo "âŒ Results directory not found!"
            exit 1
          fi

      # - name: Run Lighthouse assert
      #   run: npx lhci assert || echo "âš ï¸ Some Lighthouse assertions failed, but continuing build..."

      - name: Analyze Lighthouse results and calculate averages
        run: |
          echo "ðŸš¦ Lighthouse Performance Analysis (${{ matrix.browser }})"
          echo "=================================="
          echo "ðŸ“ Checking for Lighthouse reports..."
          ls -la .lighthouseci/ || echo "âŒ .lighthouseci directory not found"
          
          # ìƒˆë¡œìš´ ìŠ¤í¬ë¦½íŠ¸ë¡œ í‰ê· ê°’ ê³„ì‚° ë° ë¹„êµ ë¶„ì„
          if ls .lighthouseci/lhr-*.json 1> /dev/null 2>&1; then
            echo "âœ… Running Lighthouse results analysis..."
            node scripts/lighthouse-results.mjs
            
            echo ""
            echo "ðŸ“š Adding results to history..."
            node scripts/lighthouse-history.mjs add
            
            echo ""
            echo "ðŸ“ˆ Showing performance trend..."
            node scripts/lighthouse-history.mjs summary
          else
            echo "âŒ No Lighthouse report files found"
            echo "ðŸ” Available files in .lighthouseci/:"
            ls -la .lighthouseci/ 2>/dev/null || echo "Directory empty or doesn't exist"
          fi

      - name: Save current results for next comparison
        if: always()
        run: |
          echo "ðŸ’¾ Saving current results for next comparison..."
          
          # í˜„ìž¬ ê²°ê³¼ë¥¼ ë‹¤ìŒ ì‹¤í–‰ì„ ìœ„í•´ ì €ìž¥
          if [ -d ".lighthouse-current" ]; then
            echo "ðŸ“ Current results found:"
            ls -la .lighthouse-current/
            
            # ìºì‹œìš© ë³µì‚¬
            rm -rf .lighthouse-previous
            cp -r .lighthouse-current .lighthouse-previous
            echo "âœ… Results copied to .lighthouse-previous for cache"
            
            # ë‹¤ìŒ ì‹¤í–‰ì„ ìœ„í•œ ìºì‹œ ì—…ë°ì´íŠ¸ í™•ì¸
            echo "ðŸ“Š Summary of saved results:"
            for file in .lighthouse-previous/*.json; do
              if [ -f "$file" ]; then
                echo "- $(basename "$file")"
                node -e "
                  try {
                    const data = JSON.parse(require('fs').readFileSync('$file', 'utf8'));
                    console.log('  Performance: ' + data.performance + ', Accessibility: ' + data.accessibility);
                  } catch (e) {
                    console.log('  Error reading file');
                  }
                "
              fi
            done
          else
            echo "âŒ No current results directory found"
          fi

      - name: Prepare directories for artifacts upload
        if: always()
        run: |
          echo "ðŸ“ Ensuring directories exist for artifacts upload..."
          
          # .lighthouseciëŠ” ì´ë¯¸ ìžˆì–´ì•¼ í•˜ì§€ë§Œ í™•ì¸
          if [ -d ".lighthouseci" ]; then
            echo "âœ… .lighthouseci directory exists"
            file_count=$(find .lighthouseci -type f | wc -l)
            echo "   Files: $file_count"
            echo "   File list:"
            ls -la .lighthouseci/
          else
            echo "âŒ .lighthouseci directory missing - creating empty one"
            mkdir -p .lighthouseci
            echo "No Lighthouse reports generated for ${{ matrix.browser }}" > .lighthouseci/README-${{ matrix.browser }}.md
          fi
          
          # .lighthouse-current í™•ì¸ ë° ìƒì„±
          if [ -d ".lighthouse-current" ]; then
            echo "âœ… .lighthouse-current directory exists"
            file_count=$(find .lighthouse-current -type f | wc -l)
            echo "   Files: $file_count"
          else
            echo "â„¹ï¸  .lighthouse-current directory missing - creating empty one"
            mkdir -p .lighthouse-current
            echo "No current results available" > .lighthouse-current/README.md
          fi
          
          # .lighthouse-history í™•ì¸ ë° ìƒì„±
          if [ -d ".lighthouse-history" ]; then
            echo "âœ… .lighthouse-history directory exists"
            file_count=$(find .lighthouse-history -type f | wc -l)
            echo "   Files: $file_count"
          else
            echo "â„¹ï¸  .lighthouse-history directory missing - creating empty one"
            mkdir -p .lighthouse-history
            echo "No history available yet" > .lighthouse-history/README.md
          fi

      - name: Upload results as artifacts (backup)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-results-backup-${{ matrix.browser }}-${{ github.ref_name }}
          path: |
            .lighthouse-current/
            .lighthouse-history/
            .lighthouseci/
          retention-days: 7

      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-reports-${{ matrix.browser }}
          path: |
            .lighthouseci/
            !.lighthouseci/.gitkeep
          if-no-files-found: warn
          retention-days: 30
