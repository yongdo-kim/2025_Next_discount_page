name: Lighthouse CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  lighthouse:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Cache Lighthouse CI database
        uses: actions/cache@v3
        with:
          path: lhci.db
          key: lighthouse-db-${{ runner.os }}-${{ github.ref_name }}
          restore-keys: |
            lighthouse-db-${{ runner.os }}-

      - name: Cache previous Lighthouse results
        uses: actions/cache@v3
        with:
          path: .lighthouse-previous
          key: lighthouse-results-${{ runner.os }}-${{ github.ref_name }}-latest
          restore-keys: |
            lighthouse-results-${{ runner.os }}-${{ github.ref_name }}-latest
            lighthouse-results-${{ runner.os }}-${{ github.ref_name }}-

      - name: Debug cache status and fallback to artifacts
        run: |
          echo "ğŸ” Checking cache restore status..."
          echo "Cache key: lighthouse-results-${{ runner.os }}-${{ github.ref_name }}-latest"
          echo "Previous results directory:"
          if [ -d ".lighthouse-previous" ]; then
            echo "âœ… .lighthouse-previous directory exists (from cache)"
            ls -la .lighthouse-previous/ || echo "Directory is empty"
          else
            echo "âŒ .lighthouse-previous directory not found from cache"
            echo "ğŸ”„ Attempting to restore from artifacts as fallback..."
            
            # Artifacts ë°±ì—…ì—ì„œ ë³µì› ì‹œë„ (ì‹¤ì œë¡œëŠ” ìˆ˜ë™ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œí•´ì•¼ í•¨)
            # ì—¬ê¸°ì„œëŠ” ì²« ì‹¤í–‰ì„ì„ ì•Œë¦¬ëŠ” ë©”ì‹œì§€ë§Œ í‘œì‹œ
            echo "â„¹ï¸  This appears to be the first run or cache was cleared"
            echo "   Next run will have previous results to compare with"
          fi
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build project
        run: npm run build
        
      - name: Start server
        run: npm run prod &
        env:
          NODE_ENV: production

      - name: Wait for server to be ready
        run: npx wait-on http://localhost:3000 --timeout 60000

      - name: Run Lighthouse collect
        run: npx lhci collect --settings.throttling.cpuSlowdownMultiplier=4

      # - name: Run Lighthouse assert
      #   run: npx lhci assert || echo "âš ï¸ Some Lighthouse assertions failed, but continuing build..."

      - name: Display Lighthouse scores with comparison
        run: |
          echo "ğŸš¦ Lighthouse Performance Summary"
          echo "================================="
          echo "ğŸ“ Checking for Lighthouse reports..."
          ls -la .lighthouseci/ || echo "âŒ .lighthouseci directory not found"
          
          # í˜„ì¬ ê²°ê³¼ ìš”ì•½ì„ ìœ„í•œ ì„ì‹œ íŒŒì¼ ìƒì„±
          mkdir -p .lighthouse-current
          echo "ğŸ“ Created .lighthouse-current directory"
          
          # JSON íŒŒì¼ ì°¾ê¸° ë° ì²˜ë¦¬
          if ls .lighthouseci/lhr-*.json 1> /dev/null 2>&1; then
            echo "âœ… Found Lighthouse reports:"
            
            # ì „ì²´ ê²°ê³¼ë¥¼ ì €ì¥í•  ë°°ì—´
            declare -A current_scores
            
            for file in .lighthouseci/lhr-*.json; do
              echo ""
              echo "ğŸ“„ Report: $(basename "$file")"
              
              # Node.jsë¡œ ì ìˆ˜ ì¶”ì¶œ ë° ë¹„êµ
              node -e "
                try {
                  const fs = require('fs');
                  const path = require('path');
                  const lhr = JSON.parse(fs.readFileSync('$file', 'utf8'));
                  const scores = lhr.categories;
                  
                  const currentScores = {
                    performance: Math.round(scores.performance.score * 100),
                    accessibility: Math.round(scores.accessibility.score * 100),
                    bestPractices: Math.round(scores['best-practices'].score * 100),
                    seo: Math.round(scores.seo.score * 100),
                    url: lhr.finalUrl
                  };
                  
                  console.log('ğŸ¯ Performance: ' + currentScores.performance);
                  console.log('â™¿ Accessibility: ' + currentScores.accessibility); 
                  console.log('âš¡ Best Practices: ' + currentScores.bestPractices);
                  console.log('ğŸ” SEO: ' + currentScores.seo);
                  console.log('ğŸŒ URL: ' + currentScores.url);
                  
                  // í˜„ì¬ ê²°ê³¼ë¥¼ íŒŒì¼ì— ì €ì¥ (ë‹¤ìŒ ì‹¤í–‰ì„ ìœ„í•´)
                  const filename = path.basename('$file').replace('.json', '-summary.json');
                  
                  // ë””ë ‰í„°ë¦¬ ì¡´ì¬ í™•ì¸ ë° ìƒì„±
                  if (!fs.existsSync('.lighthouse-current')) {
                    fs.mkdirSync('.lighthouse-current', { recursive: true });
                  }
                  
                  fs.writeFileSync('.lighthouse-current/' + filename, JSON.stringify(currentScores, null, 2));
                  console.log('ğŸ’¾ Saved summary to: .lighthouse-current/' + filename);
                  
                  // ì´ì „ ê²°ê³¼ì™€ ë¹„êµ
                  const previousFile = '.lighthouse-previous/' + filename;
                  if (fs.existsSync(previousFile)) {
                    const previousScores = JSON.parse(fs.readFileSync(previousFile, 'utf8'));
                    
                    console.log('');
                    console.log('ğŸ“Š Changes from previous build:');
                    
                    const performanceDiff = currentScores.performance - previousScores.performance;
                    const accessibilityDiff = currentScores.accessibility - previousScores.accessibility;
                    const bestPracticesDiff = currentScores.bestPractices - previousScores.bestPractices;
                    const seoDiff = currentScores.seo - previousScores.seo;
                    
                    const getDiffEmoji = (diff) => diff > 0 ? 'ğŸ“ˆ' : diff < 0 ? 'ğŸ“‰' : 'â¡ï¸';
                    const getDiffColor = (diff) => diff >= 10 ? 'ğŸŸ¢' : diff <= -10 ? 'ğŸ”´' : 'ğŸŸ¡';
                    
                    console.log('ğŸ¯ Performance: ' + getDiffEmoji(performanceDiff) + ' ' + (performanceDiff >= 0 ? '+' : '') + performanceDiff + ' ' + getDiffColor(performanceDiff));
                    console.log('â™¿ Accessibility: ' + getDiffEmoji(accessibilityDiff) + ' ' + (accessibilityDiff >= 0 ? '+' : '') + accessibilityDiff + ' ' + getDiffColor(accessibilityDiff));
                    console.log('âš¡ Best Practices: ' + getDiffEmoji(bestPracticesDiff) + ' ' + (bestPracticesDiff >= 0 ? '+' : '') + bestPracticesDiff + ' ' + getDiffColor(bestPracticesDiff));
                    console.log('ğŸ” SEO: ' + getDiffEmoji(seoDiff) + ' ' + (seoDiff >= 0 ? '+' : '') + seoDiff + ' ' + getDiffColor(seoDiff));
                    
                    // ì‹¬ê°í•œ ì„±ëŠ¥ ì €í•˜ ê²½ê³ 
                    if (performanceDiff <= -15) {
                      console.log('');
                      console.log('âš ï¸  WARNING: Performance decreased significantly by ' + Math.abs(performanceDiff) + ' points!');
                    } else if (performanceDiff >= 10) {
                      console.log('');
                      console.log('ğŸ‰ Great! Performance improved by ' + performanceDiff + ' points!');
                    }
                  } else {
                    console.log('');
                    console.log('â„¹ï¸  No previous results to compare with.');
                  }
                  
                } catch (error) {
                  console.log('âŒ Error reading report:', error.message);
                }
              "
              echo "---"
            done
          else
            echo "âŒ No Lighthouse report files found"
            echo "ğŸ” Available files in .lighthouseci/:"
            ls -la .lighthouseci/ 2>/dev/null || echo "Directory empty or doesn't exist"
          fi

      - name: Save current results for next comparison
        if: always()
        run: |
          echo "ğŸ’¾ Saving current results for next comparison..."
          
          # í˜„ì¬ ê²°ê³¼ë¥¼ ë‹¤ìŒ ì‹¤í–‰ì„ ìœ„í•´ ì €ì¥
          if [ -d ".lighthouse-current" ]; then
            echo "ğŸ“ Current results found:"
            ls -la .lighthouse-current/
            
            # ìºì‹œìš© ë³µì‚¬
            rm -rf .lighthouse-previous
            cp -r .lighthouse-current .lighthouse-previous
            echo "âœ… Results copied to .lighthouse-previous for cache"
            
            # ë‹¤ìŒ ì‹¤í–‰ì„ ìœ„í•œ ìºì‹œ ì—…ë°ì´íŠ¸ í™•ì¸
            echo "ğŸ“Š Summary of saved results:"
            for file in .lighthouse-previous/*.json; do
              if [ -f "$file" ]; then
                echo "- $(basename "$file")"
                node -e "
                  try {
                    const data = JSON.parse(require('fs').readFileSync('$file', 'utf8'));
                    console.log('  Performance: ' + data.performance + ', Accessibility: ' + data.accessibility);
                  } catch (e) {
                    console.log('  Error reading file');
                  }
                "
              fi
            done
          else
            echo "âŒ No current results directory found"
          fi

      - name: Debug directory status before upload
        if: always()
        run: |
          echo "ğŸ” Debugging directory status for artifacts upload..."
          echo "Current working directory: $(pwd)"
          echo "\nğŸ“ Directory structure:"
          ls -la
          echo "\nğŸ“ .lighthouse-current status:"
          if [ -d ".lighthouse-current" ]; then
            echo "âœ… .lighthouse-current exists"
            ls -la .lighthouse-current/ || echo "Directory empty"
            find .lighthouse-current -type f | wc -l | xargs echo "Files count:"
          else
            echo "âŒ .lighthouse-current does not exist"
          fi
          echo "\nğŸ“ .lighthouseci status:"
          if [ -d ".lighthouseci" ]; then
            echo "âœ… .lighthouseci exists"
            ls -la .lighthouseci/ || echo "Directory empty"
            find .lighthouseci -type f | wc -l | xargs echo "Files count:"
          else
            echo "âŒ .lighthouseci does not exist"
          fi

      - name: Upload results as artifacts (backup)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-results-backup-${{ github.ref_name }}
          path: |
            .lighthouse-current/
            .lighthouseci/
          retention-days: 7
          if-no-files-found: warn

      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-reports
          path: .lighthouseci/
          retention-days: 30
          if-no-files-found: warn
